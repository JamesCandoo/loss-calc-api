<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Payroll Waste</title>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="clarity-style.css">
</head>

<body>
  <h1>Payroll Waste</h1>

  <div class="info-banner">
    <strong>This module estimates the cost of payroll inefficiency in your organisation.</strong><br>
    Enter your details below to find out how much waste might be hiding in your wage bill.
  </div>

  <form id="efficiency-form">
    <label for="industry">Industry:</label>
    <select id="industry" name="industry" required>
      <option value="">Select industry...</option>
    </select>

    <label for="total_employees">Total Employees:</label>
    <input type="number" id="total_employees" name="total_employees" required />

    <label for="avg_salary">Average Salary ($AUD):</label>
    <input type="number" id="avg_salary" name="avg_salary" required />

    <label for="improvement_rate">Improvement Rate (%):</label>
    <input type="number" id="improvement_rate" name="improvement_rate" required />

    <button type="submit" id="calculate">Calculate</button>
  </form>

  <pre id="result"></pre>

  <script>
    const MODULE = 'payroll-waste';
    const API_ENDPOINT = 'https://candoo-clarity.onrender.com/run-payroll-waste';

    document.addEventListener("DOMContentLoaded", function () {
      const form = document.getElementById("efficiency-form");
      const resultBox = document.getElementById("result");
      const industrySelect = document.getElementById("industry");

      fetch("https://candoo-clarity.onrender.com/benchmarks")
        .then(res => res.json())
        .then(data => {
          data.industries.forEach(ind => {
            const opt = document.createElement("option");
            opt.value = ind;
            opt.textContent = ind;
            industrySelect.appendChild(opt);
          });
        });

      // Restore session/localStorage inputs
      const stored = JSON.parse(localStorage.getItem(`${MODULE}-inputs`) || "null");
      if (stored) {
        form.industry.value = stored.industry || "";
        form.total_employees.value = stored.total_employees || "";
        form.avg_salary.value = stored.avg_salary || "";
        form.improvement_rate.value = stored.improvement_rate || "";
      }

      form.addEventListener("submit", function (e) {
        e.preventDefault();
        const inputs = {
          industry: form.industry.value,
          total_employees: parseInt(form.total_employees.value),
          avg_salary: parseFloat(form.avg_salary.value),
          improvement_rate: parseFloat(form.improvement_rate.value),
        };

        resultBox.textContent = "Calculating...";

        fetch(API_ENDPOINT, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(inputs)
        })
          .then(res => res.json())
          .then(result => {
            if (result.formatted_labels) {
              let out = "";
              Object.entries(result.formatted_labels).forEach(([label, val]) => {
                out += `${label}: ${val}\n`;
              });
              resultBox.textContent = out;
              localStorage.setItem(`${MODULE}-inputs`, JSON.stringify(inputs));
              console.log("✅ Payroll data saved to localStorage", inputs);
            } else {
              resultBox.textContent = "Something went wrong.";
            }
          })
          .catch(err => {
            console.error("Error:", err);
            resultBox.textContent = "API error. Try again.";
          });
      });
    });

    // Safe rebind for dynamic loads via index.html
    document.addEventListener("clarity:moduleLoaded", () => {
      const form = document.getElementById("efficiency-form");
      if (!form) return;
      const btn = form.querySelector("button[type='submit']");
      if (btn && !btn.dataset.bound) {
        btn.addEventListener("click", (e) => {
          e.preventDefault();
          form.dispatchEvent(new Event("submit", { cancelable: true, bubbles: true }));
        });
        btn.dataset.bound = "true";
        console.log("✅ Payroll calculate button rebound via clarity:moduleLoaded");
      }
    });
  </script>
</body>

</html>